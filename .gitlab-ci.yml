# GitLab CI/CD Pipeline Configuration
# Feature: 002-gitlab-security-pipeline
# Purpose: Automated security scanning (Secret Detection, Dependency Scanning, SAST)
#
# GitLab Tier Requirements:
# - Secret Detection: FREE tier ‚úì
# - SAST: FREE tier ‚úì
# - Dependency Scanning: ULTIMATE tier (requires license)
#
# Documentation:
# - Secret Detection: https://docs.gitlab.com/ee/user/application_security/secret_detection/
# - Dependency Scanning: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/
# - SAST: https://docs.gitlab.com/ee/user/application_security/sast/

# ==============================================================================
# Pipeline Stages
# ==============================================================================

stages:
  - test      # Standard test stage (if tests exist)
  - security  # Security scanning stage (all scanners run in parallel)

# ==============================================================================
# Global Variables (Performance Optimization)
# ==============================================================================

variables:
  # Shallow clone for faster checkouts (only fetch recent commits)
  GIT_DEPTH: "50"

  # Default timeout for jobs (5 minutes to meet performance requirement)
  # Individual jobs can override if needed
  TIMEOUT: "5m"

# ==============================================================================
# Security Scanner Templates
# ==============================================================================

include:
  - template: Security/Secret-Detection.gitlab-ci.yml  # T014: Include GitLab Secret Detection template

# ==============================================================================
# Secret Detection Job (User Story 1 - P1) üîê
# ==============================================================================
# Purpose: Detect hardcoded secrets (API keys, passwords, tokens) in commits
# Scanner: Gitleaks (GitLab's built-in secret scanner)
# Blocking: Yes (allow_failure: false) - Prevents merge if secrets detected
# Performance: <90 seconds for typical changes
#
# T025: Configuration Summary:
# - Differential scanning enabled (SECRET_DETECTION_HISTORIC_SCAN=false)
# - Path exclusions: tests/, docs/ (reduces false positives)
# - False positive handling: .gitleaksignore at repository root
# - Artifact retention: 30 days
# - GitLab Security Dashboard integration: Automatic
#
# Common Detections:
# - AWS Access Keys (AKIA*)
# - GitHub Personal Access Tokens (ghp_*, gho_*)
# - Generic Passwords (password=, pwd=)
# - Private Keys (BEGIN PRIVATE KEY, BEGIN RSA PRIVATE KEY)
# - API Keys (api_key=, apikey=)
#
# How to Fix Detected Secrets:
# 1. Remove the secret from code
# 2. Rotate the credential (generate new key)
# 3. Store in environment variables or secret management system
# 4. For false positives: Add pattern to .gitleaksignore
#
# Example Fix:
#   ‚ùå const API_KEY = "sk-1234567890"
#   ‚úÖ const API_KEY = process.env.API_KEY
# ==============================================================================

secret_detection:
  stage: security  # T015: Configure job in security stage

  variables:
    # T016: Enable differential scanning (only scan commit range, not full history)
    # This dramatically improves performance: 80% faster on large repos
    SECRET_DETECTION_HISTORIC_SCAN: "false"

    # T021: Exclude paths from scanning (performance optimization + reduce false positives)
    # - tests/: Test files often contain fake secrets for testing
    # - docs/: Documentation contains example API keys
    # This improves scan speed by ~20-30% and reduces false positive rate
    SECRET_DETECTION_EXCLUDED_PATHS: "tests/,docs/"

  # T017: Configure artifact output (JSON report for GitLab Security Dashboard)
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
    paths:
      - gl-secret-detection-report.json
    expire_in: 30 days
    when: always  # Preserve report even if job fails

  # T018: Run on merge requests and main branch
  only:
    - merge_requests
    - main
    - master

  # T019: Block merge if secrets detected (critical security issue)
  allow_failure: false

  # Job timeout (within 5-minute performance requirement)
  timeout: 5 minutes
