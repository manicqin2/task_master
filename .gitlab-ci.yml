# GitLab CI/CD Pipeline Configuration
# Feature: 002-gitlab-security-pipeline
# Purpose: Automated security scanning (Secret Detection, Dependency Scanning, SAST)
#
# GitLab Tier Requirements:
# - Secret Detection: FREE tier ‚úì
# - SAST: FREE tier ‚úì
# - Dependency Scanning: ULTIMATE tier (requires license)
#
# Documentation:
# - Secret Detection: https://docs.gitlab.com/ee/user/application_security/secret_detection/
# - Dependency Scanning: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/
# - SAST: https://docs.gitlab.com/ee/user/application_security/sast/

# ==============================================================================
# Pipeline Stages
# ==============================================================================

stages:
  - test      # Standard test stage (if tests exist)
  - security  # Security scanning stage (all scanners run in parallel)

# ==============================================================================
# Global Variables (Performance Optimization)
# ==============================================================================

variables:
  # Shallow clone for faster checkouts (only fetch recent commits)
  GIT_DEPTH: "50"

  # Default timeout for jobs (5 minutes to meet performance requirement)
  # Individual jobs can override if needed
  TIMEOUT: "5m"

# ==============================================================================
# Security Scanner Templates
# ==============================================================================

include:
  - template: Security/Secret-Detection.gitlab-ci.yml  # T014: Include GitLab Secret Detection template
  - template: Security/Dependency-Scanning.gitlab-ci.yml  # T030: Include GitLab Dependency Scanning template
  - template: Security/SAST.gitlab-ci.yml  # T046: Include GitLab SAST template

# ==============================================================================
# Secret Detection Job (User Story 1 - P1) üîê
# ==============================================================================
# Purpose: Detect hardcoded secrets (API keys, passwords, tokens) in commits
# Scanner: Gitleaks (GitLab's built-in secret scanner)
# Blocking: Yes (allow_failure: false) - Prevents merge if secrets detected
# Performance: <90 seconds for typical changes
#
# T025: Configuration Summary:
# - Differential scanning enabled (SECRET_DETECTION_HISTORIC_SCAN=false)
# - Path exclusions: tests/, docs/ (reduces false positives)
# - False positive handling: .gitleaksignore at repository root
# - Artifact retention: 30 days
# - GitLab Security Dashboard integration: Automatic
#
# Common Detections:
# - AWS Access Keys (AKIA*)
# - GitHub Personal Access Tokens (ghp_*, gho_*)
# - Generic Passwords (password=, pwd=)
# - Private Keys (BEGIN PRIVATE KEY, BEGIN RSA PRIVATE KEY)
# - API Keys (api_key=, apikey=)
#
# How to Fix Detected Secrets:
# 1. Remove the secret from code
# 2. Rotate the credential (generate new key)
# 3. Store in environment variables or secret management system
# 4. For false positives: Add pattern to .gitleaksignore
#
# Example Fix:
#   ‚ùå const API_KEY = "sk-1234567890"
#   ‚úÖ const API_KEY = process.env.API_KEY
# ==============================================================================

secret_detection:
  stage: security  # T015: Configure job in security stage

  variables:
    # T016: Enable differential scanning (only scan commit range, not full history)
    # This dramatically improves performance: 80% faster on large repos
    SECRET_DETECTION_HISTORIC_SCAN: "false"

    # T021: Exclude paths from scanning (performance optimization + reduce false positives)
    # - tests/: Test files often contain fake secrets for testing
    # - docs/: Documentation contains example API keys
    # This improves scan speed by ~20-30% and reduces false positive rate
    SECRET_DETECTION_EXCLUDED_PATHS: "tests/,docs/"

  # T017: Configure artifact output (JSON report for GitLab Security Dashboard)
  artifacts:
    reports:
      secret_detection: gl-secret-detection-report.json
    paths:
      - gl-secret-detection-report.json
    expire_in: 30 days
    when: always  # Preserve report even if job fails

  # T018: Run on merge requests and main branch
  only:
    - merge_requests
    - main
    - master

  # T019: Block merge if secrets detected (critical security issue)
  allow_failure: false

  # Job timeout (within 5-minute performance requirement)
  timeout: 5 minutes

# ==============================================================================
# Dependency Scanning Job (User Story 2 - P2) üì¶
# ==============================================================================
# Purpose: Detect known CVEs in npm and Python dependencies
# Scanner: Gemnasium (GitLab's built-in dependency scanner)
# Blocking: Yes (allow_failure: false) - Blocks high/critical CVEs
# Performance: <120 seconds for typical changes
# GitLab Tier: ULTIMATE required (not available in Free tier)
#
# T037-T039: Configuration Summary:
# - Scans package.json, package-lock.json (npm)
# - Scans requirements.txt, pyproject.toml (Python)
# - Path exclusions: tests/, docs/
# - Queries NVD CVE database for vulnerabilities
# - Artifact retention: 30 days
# - GitLab Security Dashboard integration: Automatic
#
# Common Detections:
# - Outdated npm packages (lodash, minimist, axios, etc.)
# - Outdated Python packages (Django, Pillow, urllib3, etc.)
# - Transitive dependencies with CVEs
# - Severity ratings: Critical, High, Medium, Low
#
# How to Fix Detected CVEs:
# 1. Review the CVE details in the security report
# 2. Check if a patch version is available
# 3. Update package.json or requirements.txt:
#    npm: npm update <package>
#    Python: pip install --upgrade <package>
# 4. If no patch available: Risk acceptance workflow or find alternatives
# 5. For transitive dependencies: Update parent package
#
# Risk Acceptance Workflow:
# - Document vulnerability in .gitlab/security-policies.yml
# - Add risk acceptance with expiration date
# - Require security team approval
# - Review regularly (30-day cycles recommended)
#
# Example Fix:
#   ‚ùå "lodash": "4.17.20"  (CVE-2020-8203)
#   ‚úÖ "lodash": "^4.17.21"  (patched version)
# ==============================================================================

dependency_scanning:
  stage: security  # T031: Configure job in security stage

  variables:
    # T036: Exclude paths from scanning (performance optimization)
    # - tests/: Test files often have intentionally vulnerable dependencies
    # - docs/: Documentation doesn't need dependency scanning
    DS_EXCLUDED_PATHS: "tests/,docs/"

  # T032: Configure artifact output (JSON report for GitLab Security Dashboard)
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    paths:
      - gl-dependency-scanning-report.json
    expire_in: 30 days
    when: always  # Preserve report even if job fails

  # T033: Run on merge requests and main branch
  only:
    - merge_requests
    - main
    - master

  # T034: Block merge if high/critical CVEs detected
  allow_failure: false

  # Job timeout (within 5-minute performance requirement)
  timeout: 5 minutes

# ==============================================================================
# SAST Job (User Story 3 - P3) üîç
# ==============================================================================
# Purpose: Detect code-level security vulnerabilities (SQL injection, XSS, weak crypto)
# Scanner: Semgrep (GitLab's built-in SAST engine)
# Blocking: No (allow_failure: true) - Warning-only, doesn't block merge
# Performance: <180 seconds for typical changes
# GitLab Tier: FREE tier ‚úì
#
# T047-T050: Configuration Summary:
# - Multi-language support: JavaScript, TypeScript, Python, Go, Java, etc.
# - Confidence level: HIGH (reduces false positives)
# - Path exclusions: tests/, docs/ (performance + reduce noise)
# - Artifact retention: 30 days
# - GitLab Security Dashboard integration: Automatic
#
# Common Detections:
# - SQL Injection (CWE-89): String concatenation in SQL queries
# - Cross-Site Scripting (CWE-79): Unsafe HTML rendering, dangerouslySetInnerHTML
# - Code Injection (CWE-95): eval(), exec() with user input
# - Weak Cryptography (CWE-327): MD5, SHA1, DES, RC4 algorithms
# - Insecure Random (CWE-330): random module instead of secrets
# - Hardcoded Secrets (CWE-798): Credentials in source code
# - Command Injection (CWE-78): Shell commands with user input
# - Path Traversal (CWE-22): File access with user-controlled paths
#
# How to Fix SAST Findings:
# 1. Review the finding in GitLab Security Dashboard
# 2. Check the CWE link for vulnerability details
# 3. Apply the suggested remediation:
#    - SQL Injection: Use parameterized queries
#    - XSS: Sanitize HTML with DOMPurify or use textContent
#    - Weak Crypto: Use bcrypt, AES-256-GCM, secrets module
#    - Hardcoded Secrets: Move to environment variables
# 4. Test the fix and verify scanner no longer flags it
# 5. For false positives: Add inline comment "# nosec" with justification
#
# Example Fixes:
#   ‚ùå const query = "SELECT * FROM users WHERE id = '" + userId + "'"
#   ‚úÖ db.query("SELECT * FROM users WHERE id = ?", [userId])
#
#   ‚ùå <div dangerouslySetInnerHTML={{ __html: userBio }} />
#   ‚úÖ <div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(userBio) }} />
#
#   ‚ùå hashlib.md5(password.encode()).hexdigest()
#   ‚úÖ bcrypt.hashpw(password.encode(), bcrypt.gensalt())
#
# False Positive Handling:
# - Add inline suppression comment with justification:
#   Python: # nosec B303 (MD5 used for non-security purpose)
#   JavaScript: // eslint-disable-next-line security/detect-sql-injection
# - Document in code review why it's safe
# ==============================================================================

sast:
  stage: security  # T047: Configure job in security stage

  variables:
    # T049: Set confidence level to HIGH to reduce false positives
    # Options: HIGH (recommended), MEDIUM, LOW
    # HIGH confidence = fewer false positives, may miss some low-confidence issues
    SAST_CONFIDENCE_LEVEL: "HIGH"

    # T050: Exclude paths from scanning (performance optimization + reduce noise)
    # - tests/: Test files often contain intentional vulnerable code for testing
    # - docs/: Documentation contains code examples that may trigger false positives
    SAST_EXCLUDED_PATHS: "tests/,docs/"

  # T048: Configure artifact output (JSON report for GitLab Security Dashboard)
  artifacts:
    reports:
      sast: gl-sast-report.json
    paths:
      - gl-sast-report.json
    expire_in: 30 days
    when: always  # Preserve report even if job fails

  # Run on merge requests and main branch
  only:
    - merge_requests
    - main
    - master

  # T051: Warning-only mode (don't block merge)
  # SAST findings are informational and should be reviewed but not block deployment
  # This allows teams to gradually improve security posture without disrupting workflow
  allow_failure: true

  # Job timeout (within 5-minute performance requirement)
  timeout: 5 minutes
